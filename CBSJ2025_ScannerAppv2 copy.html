<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Boot Sale JA - Verification Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding: 1rem;
        }
        .scanner-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <div class="scanner-container">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">Seller Gate Scanner</h1>
        <p class="text-center text-sm text-gray-600 mb-6">Point your camera at the seller's QR Code/Pass.</p>

        <div id="reader"></div>

        <div id="scan-result" class="mt-4 p-4 rounded-lg border-2 text-center transition-all duration-300">
            <p class="text-lg font-semibold text-gray-500">Awaiting Scan...</p>
        </div>
        
        <div id="detail-card" class="hidden mt-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Seller Details</h3>
            <div class="space-y-2 text-sm">
                <p><span class="font-semibold">Name:</span> <span id="detail-name" class="font-medium text-gray-700"></span></p>
                <p><span class="font-semibold">Booking ID:</span> <span id="detail-id" class="font-medium text-gray-700"></span></p>
                <p><span class="font-semibold">Spot Type:</span> <span id="detail-type" class="font-medium text-gray-700"></span></p>
                <p><span class="font-semibold">Paid Status:</span> <span id="detail-paid" class="font-medium text-gray-700"></span></p>
            </div>
            <button id="reset-button" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">Scan Next Pass</button>
        </div>

        <div class="mt-6 p-4 bg-white border border-gray-300 rounded-lg shadow-inner">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Entry Summary</h3>
            <p class="text-lg mb-3">
                <span class="font-semibold">Total Verified Entries:</span> 
                <span id="entry-count" class="text-2xl font-extrabold text-green-600">0</span>
            </p>
            <div class="max-h-40 overflow-y-auto border-t pt-2">
                <p class="font-semibold text-gray-600 mb-1">Entrants:</p>
                <ul id="entrant-list" class="list-disc list-inside text-sm text-gray-700">
                    <li id="empty-list-message" class="text-gray-400">No entries recorded yet.</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        // --- 1. MOCK MASTER LIST (MODIFIED) ---
        // ADDED: `entered: false` to all entries
        const masterList = [

{ id: "CBSJA-2025-0013", name: "Marria Thorpe", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0014", name: "Marsha Henry", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0015", name: "Karrell Bloomfield", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0016", name: "Peta Gaye Lopez", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0017", name: "Tamar Palmer", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0018", name: "Nigel Douglas", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0019", name: "Trevor Muir", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0020", name: "Nadia Williams-Rainford", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0021", name: "Shashu Payne", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0022", name: "Cavell Robinson", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0023", name: "Jessica Lewis", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0024", name: "Danielle Graham", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0025", name: "Deveane Roberts", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0026", name: "Kristen Cousley", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0027", name: "Tanya Collins", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0028", name: "Lorna Morrison", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0029", name: "Amanda Rochester", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0030", name: "Patrick Phillips", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0031", name: "Lorette Matthews", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0001", name: "Joycelyn Kitchen ", type: "Food Vendor", paid: "7500", status: "" , entered: "false" }, { id: "CBSJA-2025-0002", name: "Ricky-Bad Dawg", type: "Food Vendor", paid: "7500", status: "" , entered: "false" }, { id: "CBSJA-2025-0003", name: "Pop Style Cake Pops Ja", type: "Food Vendor", paid: "7500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0004", name: "Refreshment", type: "Food Vendor", paid: "7500", status: "" , entered: "false" }, { id: "CBSJA-2025-0005", name: "Salada Foods", type: "Sponsor", paid: "N/A", status: "" , entered: "false" }, { id: "CBSJA-2025-0006", name: "Niche Financing", type: "Sponsor", paid: "N/A", status: "" , entered: "false" }, { id: "CBSJA-2025-0032", name: "Daphne Lindo", type: "Seller Spot", paid: "$4,000", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0033", name: "Sonia Huie", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0034", name: "Paula Surtees", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0035", name: "Meyanda Henderson", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0036", name: "Jermaine Burton", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0037", name: "September Mckenzie", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0038", name: "Raquel Phillpotts", type: "Seller Spot (EB)", paid: "$3,500", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0039", name: "Rose-Ann Tomlinson", type: "Seller Spot", paid: "$4,000", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0040", name: "Claudia Thompson-Roache", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, { id: "CBSJA-2025-0041", name: "Shamiel Bloomfield", type: "Seller Spot", paid: "$4,000", status: "Paid" , entered: "false" }, { id: "CBSJA-2025-0042", name: "Charolee Pandohie", type: "INVALID", paid: "0", status: "Awaiting Payment" , entered: "false" }, 




        ];

        let html5QrCode;
        const resultElement = document.getElementById('scan-result');
        const detailCard = document.getElementById('detail-card');
        const resetButton = document.getElementById('reset-button');
        
        // NEW: Summary Elements
        const entryCountElement = document.getElementById('entry-count');
        const entrantListElement = document.getElementById('entrant-list');
        const emptyListMessage = document.getElementById('empty-list-message');
        
        // --- 2. SUCCESS HANDLER: Called when a QR code is detected ---
        const onScanSuccess = (decodedText, decodedResult) => {
            // Stop the scanner immediately upon successful scan
            html5QrCode.stop().then((ignore) => {
                console.log(`Scan successful: ${decodedText}`);
                
                // Try to find the Booking ID in the master list
                const bookingId = decodedText.trim();
                const seller = masterList.find(s => s.id === bookingId);
                
                let message = '';
                let resultClass = '';
                
                if (seller && seller.status === 'Paid' && seller.entered === false) {
                    // VERIFIED SUCCESS - FIRST ENTRY
                    message = 'ACCESS GRANTED - Spot Confirmed!';
                    resultClass = 'bg-green-100 border-green-500 text-green-700';
                    
                    // NEW: Mark as entered and update summary
                    seller.entered = true;
                    updateSummary(seller.name);

                    // Display details
                    document.getElementById('detail-name').textContent = seller.name;
                    document.getElementById('detail-id').textContent = seller.id;
                    document.getElementById('detail-type').textContent = seller.type;
                    document.getElementById('detail-paid').textContent = seller.paid;
                    detailCard.classList.remove('hidden');

                } else if (seller && seller.status === 'Paid' && seller.entered === true) {
                    // DUPLICATE SCAN
                    message = 'ENTRY DENIED - Pass Already Used!';
                    resultClass = 'bg-red-200 border-red-600 text-red-800';
                    
                    // Display details (still show who it is)
                    document.getElementById('detail-name').textContent = seller.name;
                    document.getElementById('detail-id').textContent = seller.id;
                    document.getElementById('detail-type').textContent = seller.type;
                    document.getElementById('detail-paid').textContent = seller.paid;
                    detailCard.classList.remove('hidden');

                } else if (seller && seller.status !== 'Paid') {
                    // PENDING or CANCELED (Found, but not confirmed)
                    message = `ACCESS DENIED - Status: ${seller.status}`;
                    resultClass = 'bg-yellow-100 border-yellow-500 text-yellow-700';
                    
                    // Display details
                    document.getElementById('detail-name').textContent = seller.name;
                    document.getElementById('detail-id').textContent = seller.id;
                    document.getElementById('detail-type').textContent = seller.type;
                    document.getElementById('detail-paid').textContent = 'â€”';
                    detailCard.classList.remove('hidden');

                } else {
                    // FAILED (ID not found in master list)
                    message = 'INVALID PASS - Spot Not Found!';
                    resultClass = 'bg-red-100 border-red-500 text-red-700';
                    detailCard.classList.add('hidden');
                }
                
                // Update the visual result box
                resultElement.className = `mt-4 p-4 rounded-lg border-2 text-center transition-all duration-300 ${resultClass}`;
                resultElement.innerHTML = `<p class="text-xl font-bold">${message}</p><p class="text-sm mt-1">ID Scanned: ${bookingId}</p>`;
                
            }).catch((err) => {
                console.error("Failed to stop scanner: ", err);
            });
        };

        // --- 3. ERROR HANDLER ---
        const onScanError = (errorMessage) => {
            // This runs constantly when no QR code is in view. We generally ignore it.
            // console.warn(`QR Code Scan Error: ${errorMessage}`);
        };

        // --- 4. INITIALIZE SCANNER ---
        function startScanner() {
             html5QrCode = new Html5Qrcode("reader");

             const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                disableFlip: false 
             };

             // This tells the scanner to prefer the back camera on mobile devices
             html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
                .catch(err => {
                    const specificError = err.name || 'UnknownError';
                    
                    // NEW: Display the specific error code
                    resultElement.className = 'mt-4 p-4 rounded-lg border-2 bg-red-200 border-red-600 text-red-800';
                    resultElement.innerHTML = `<p class="text-xl font-bold">CAMERA ERROR (${specificError})</p><p class="text-sm mt-1">Please ensure you granted permissions and refresh the page.</p>`;
                    console.error("Camera failed to start: ", err);
                });
        }
        
        // --- 5. RESET FUNCTION ---
        function resetScanner() {
            detailCard.classList.add('hidden');
            resultElement.className = 'mt-4 p-4 rounded-lg border-2 text-center transition-all duration-300';
            resultElement.innerHTML = '<p class="text-lg font-semibold text-gray-500">Awaiting Scan...</p>';
            startScanner();
        }
        
        // --- 6. NEW: SUMMARY UPDATE FUNCTION ---
        function updateSummary(entrantName) {
            // 1. Update the count
            const currentCount = parseInt(entryCountElement.textContent) + 1;
            entryCountElement.textContent = currentCount;
            
            // 2. Remove the "No entries" message if it exists
            if (emptyListMessage) {
                emptyListMessage.remove();
            }

            // 3. Add the new entrant to the list
            const listItem = document.createElement('li');
            listItem.textContent = entrantName;
            entrantListElement.appendChild(listItem);
        }

        // --- 7. EVENT LISTENERS ---
        window.onload = startScanner;
        resetButton.addEventListener('click', resetScanner);
    </script>
</body>
</html>